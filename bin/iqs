#!/usr/bin/env bash

if (( "$(id -u)" != 0 )); then
    echo '! Run it as root'
    exit 1
fi

read -p '- Interface name: ' iname
if [[ "$1" == 'b' ]]; then
    read -p '- SSID: ' name
    read -sp '- Password: ' password; echo
fi

# systemd-networkd
file='20-wired.network'
[[ "$1" == 'b' ]] && file='25-wireless.network'
echo -e "[Match]\nName=${iname}\n\n[Network]\nDHCP=yes" > "/etc/systemd/network/$file"
[[ "$1" == 'b' ]] && echo 'IgnoreCarrierLoss=3s' >> "/etc/systemd/network/$file"

if [[ "$1" == 'b' ]]; then
    # wpa_supplicant
    echo -e 'ctrl_interface=/run/wpa_supplicant\nctrl_interface_group=wheel\nfast_reauth=1' > "/etc/wpa_supplicant/wpa_supplicant-${iname}.conf"
    wpa_passphrase "$name" "$password" | sed '/#/d' >> "/etc/wpa_supplicant/wpa_supplicant-${iname}.conf"
    systemctl enable --now "wpa_supplicant@${iname}"
fi

systemctl enable --now "dhcpcd@${iname}"