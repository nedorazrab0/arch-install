#!/usr/bin/sh
#
# Download and run the main script

set -e
readonly path='/tmp/njk'

# net tweaks
sysctl -w net.ipv4.tcp_timestamps=0
sysctl -w net.ipv4.tcp_fastopen=3
sysctl -w net.core.somaxconn=8192
sysctl -w net.ipv4.tcp_ecn=1
sysctl -w net.ipv4.tcp_congestion_control='bbr'

# ntp
cat << 'EOF' > /etc/systemd/timesyncd.conf
[Time]
NTP=
FallbackNTP=time.google.com
EOF

systemctl restart systemd-timesyncd

curl -fLo "${path}i" \
  'https://github.com/nedorazrab0/arch-install/releases/download/rolling/njki'
echo
sha="$(openssl sha256 ${path}i | cut -d ' ' -f2)"
shapart="${sha:0:2}-${sha:2:3}-${sha:5:3}--${sha:8:2}-${sha:10:3}-${sha:13:3}"

echo '- SHA256 Part:'
echo "  ${shapart}"
sleep 2

[[ -d "${path}" ]] && rm -rf "${path}"
mkdir -p "${path}"
zstd -dc "${path}i" | bsdtar -x -C "${path}"
rm -f "${path}i"
exec sh "${path}/main"
